name: Build NixOS ISO

on:
  push:
    branches:
      - main
    paths:
      - 'iso/**'
      - 'flake.nix'
      - 'flake.lock'
      - '.github/workflows/build-iso.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'iso/**'
      - 'flake.nix'
      - 'flake.lock'
      - '.github/workflows/build-iso.yml'
  workflow_dispatch: # Allow manual triggers

jobs:
  build-iso:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: ${{ secrets.CACHIX_AUTH_TOKEN == '' }}

      - name: Build ISO image
        run: |
          nix build .#iso --print-build-logs

      - name: Get ISO filename
        id: iso-info
        run: |
          ISO_PATH=$(readlink -f result/iso/*.iso)
          ISO_NAME=$(basename "$ISO_PATH")
          echo "iso_path=$ISO_PATH" >> $GITHUB_OUTPUT
          echo "iso_name=$ISO_NAME" >> $GITHUB_OUTPUT

          # Get file size in MB
          SIZE_MB=$(du -m "$ISO_PATH" | cut -f1)
          echo "iso_size_mb=$SIZE_MB" >> $GITHUB_OUTPUT

      - name: Upload ISO as artifact
        uses: actions/upload-artifact@v4
        with:
          name: nixos-installer-iso
          path: ${{ steps.iso-info.outputs.iso_path }}
          retention-days: 30
          compression-level: 0 # ISO is already compressed

      - name: Create Release on Tag
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.iso-info.outputs.iso_path }}
          body: |
            ## NixOS Installer ISO

            **Size:** ${{ steps.iso-info.outputs.iso_size_mb }} MB
            **Filename:** ${{ steps.iso-info.outputs.iso_name }}

            ### Features
            - Auto-installer with desktop configuration
            - KDE Plasma desktop environment
            - dm-verity support for verified boot
            - Pre-configured for disko-based installation

            ### Usage
            1. Download the ISO image
            2. Write to USB: `dd if=${{ steps.iso-info.outputs.iso_name }} of=/dev/sdX bs=4M status=progress`
            3. Boot from USB and run: `sudo /etc/installer/install.sh`

            Built from commit ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ISO build completed successfully!\n\n**Artifact:** nixos-installer-iso\n**Size:** ${{ steps.iso-info.outputs.iso_size_mb }} MB\n**Filename:** ${{ steps.iso-info.outputs.iso_name }}`
            })
